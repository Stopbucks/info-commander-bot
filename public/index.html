<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Info Commander Console v2.0</title>
    <style>
        /* æ ¸å¿ƒé…è‰²ï¼šç¶­æŒæ‚¨åŸæœ¬å–œæ­¡çš„ VS Code æ·±è‰²é¢¨æ ¼ */
        :root { --bg: #1e1e1e; --panel: #252526; --text: #d4d4d4; --accent: #0e639c; --border: #3c3c3c; --hover: #2a2d2e; --success: #4ec9b0; --warn: #ce9178; }
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
        
        /* å·¦å´ï¼šRSS åˆ—è¡¨å€ */
        #sidebar { width: 340px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .sidebar-header { padding: 15px; border-bottom: 1px solid var(--border); background: #333; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 0; }
        
        .list-item { padding: 12px 15px; border-bottom: 1px solid #333; cursor: pointer; transition: 0.2s; font-size: 13px; line-height: 1.5; }
        .list-item:hover { background: var(--hover); border-left: 3px solid var(--accent); padding-left: 12px; }
        .item-source { color: #569cd6; font-weight: bold; font-size: 11px; margin-bottom: 4px; display: block; }
        .item-date { font-size: 11px; color: #666; display: block; margin-top: 4px; }

        /* å³å´ï¼šä¸»å·¥ä½œå€ */
        #main { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 15px; background: var(--bg); position: relative; }
        
        /* Command Center (æ–°çš„æ§åˆ¶é¢æ¿) */
        .command-center { background: var(--panel); padding: 15px; border-radius: 6px; border: 1px solid var(--border); margin-bottom: 10px; }
        .command-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; flex-wrap: wrap; }
        .row-label { font-size: 11px; color: #888; text-transform: uppercase; font-weight: bold; width: 80px; flex-shrink: 0;}
        
        /* æŒ‰éˆ•æ¨£å¼å„ªåŒ– */
        button { background: var(--accent); color: white; border: none; padding: 6px 14px; cursor: pointer; border-radius: 3px; font-size: 12px; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; min-width: 80px; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button:disabled { background: #444; cursor: not-allowed; opacity: 0.7; }
        
        .btn-secondary { background: #3c3c3c; }
        .btn-youtube { background: #c4302b; } /* YouTube ç´… */
        .btn-search { background: #d7ba7d; color: #1e1e1e; font-weight: bold; } /* Google é»ƒ */
        .btn-publish { background: #2da042; } /* ç™¼å¸ƒç¶  */
        .btn-special { background: #8e44ad; } /* ç‰¹æ®Šç´« */

        /* ç·¨è¼¯å€ */
        .editor-container { flex: 1; display: flex; flex-direction: column; }
        textarea { flex: 1; background: #1e1e1e; border: 1px solid var(--border); color: #d4d4d4; padding: 15px; font-family: Consolas, 'Courier New', monospace; font-size: 14px; resize: none; outline: none; line-height: 1.6; border-radius: 4px; }
        textarea:focus { border-color: var(--accent); }

        /* ç‹€æ…‹åˆ— */
        #status-bar { height: 25px; margin-top: 5px; display: flex; align-items: center; font-size: 12px; color: #888; border-top: 1px solid var(--border); padding-top: 5px; justify-content: space-between;}
        .status-left { display: flex; align-items: center; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #666; margin-right: 8px; }
        .status-loading .status-dot { background: #dcdcaa; animation: blink 1s infinite; }
        .status-success .status-dot { background: #6a9955; }
        .status-error .status-dot { background: #f48771; }
        
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="sidebar-header">
            <span>ğŸ“¡ Info Stream</span>
            <button class="btn-secondary" onclick="loadRSS()" style="min-width:auto; padding: 4px 8px;">â†»</button>
        </div>
        <div id="list-container" class="sidebar-content">
            <div style="padding:20px; text-align:center; color:#666; font-size:12px;">
                ç³»çµ±å°±ç·’<br>é»æ“Šä¸Šæ–¹åˆ·æ–°è¼‰å…¥ RSS
            </div>
        </div>
    </div>

    <div id="main">
        
        <div class="command-center">
            
            <div class="command-row">
                <span class="row-label">Ingestion</span>
                <button class="btn-secondary" onclick="loadRSS()">ğŸ“¡ è®€å– RSS</button>
                <button class="btn-youtube" onclick="getYouTubeTrends()">ğŸ“º YouTube ç†±æœ</button>
                <button class="btn-search" onclick="alert('ğŸš§ å¾…é–‹ç™¼ï¼šGoogle Custom Search API')">ğŸ” é—œéµå­—åµæ¸¬</button>
            </div>

            <div class="command-row">
                <span class="row-label">AI Process</span>
                <button class="btn-secondary" onclick="analyzeUrl()">ğŸ§  ç¶²å€æ‘˜è¦</button>
                <button class="btn-secondary" onclick="generateDraft()">âœ¨ ç”Ÿæˆ Gate è²¼æ–‡</button>
                <button class="btn-special" onclick="triggerDaily()">ğŸš€ æ¯æ—¥è‡ªå‹•æ’ç¨‹</button>
            </div>

            <div class="command-row">
                <span class="row-label">Publish</span>
                <button class="btn-publish" onclick="publish('post_finance')">ğŸ’° ç™¼å¸ƒè²¡ç¶“</button>
                <button class="btn-publish" style="background:#ce9178;" onclick="publish('post_sports')">ğŸ€ ç™¼å¸ƒé«”è‚²</button>
            </div>
        </div>
        
        <div class="editor-container">
            <textarea id="editor" placeholder="// Draft Editor v2.0&#10;// åœ¨æ­¤è²¼ä¸Šç¶²å€ï¼Œæˆ–ç›´æ¥æ’°å¯«å…§å®¹...&#10;// é»æ“Šå·¦å´åˆ—è¡¨å¯è‡ªå‹•å¸¶å…¥é€£çµ"></textarea>
        </div>

        <div id="status-bar">
            <div class="status-left">
                <div class="status-dot"></div>
                <span id="status-text">System Ready</span>
            </div>
            <span id="clock-display" style="font-family: monospace;">--:--:--</span>
        </div>
    </div>

    <script>
        // === å…¨åŸŸè®Šæ•¸ ===
        const editor = document.getElementById('editor');
        const listContainer = document.getElementById('list-container');
        const statusText = document.getElementById('status-text');
        const statusBar = document.getElementById('status-bar');
        const clockDisplay = document.getElementById('clock-display');

        // === 1. ä»‹é¢åŸºç¤åŠŸèƒ½ (æ™‚é˜èˆ‡ç‹€æ…‹) ===
        function updateClock() {
            const now = new Date();
            clockDisplay.textContent = now.toLocaleTimeString('zh-TW', { hour12: false });
        }
        setInterval(updateClock, 1000); 
        updateClock();

        function setStatus(msg, type='idle') {
            statusText.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            statusBar.className = `status-${type}`;
            const dot = document.querySelector('.status-dot');
            if(type === 'loading') dot.style.background = '#dcdcaa'; 
            else if(type === 'success') dot.style.background = '#6a9955';
            else if(type === 'error') dot.style.background = '#f48771';
            else dot.style.background = '#666';
        }

        // === 2. RSS åŠŸèƒ½ ===
        async function loadRSS() {
            setStatus('æ­£åœ¨æŠ“å– RSS è¨Šè™Ÿ...', 'loading');
            listContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">Loading...</div>';
            try {
                const res = await fetch('/api/rss', { method: 'POST' });
                const items = await res.json();
                
                listContainer.innerHTML = '';
                if(items.length === 0) {
                    listContainer.innerHTML = '<div style="padding:20px; text-align:center;">ç„¡è³‡æ–™</div>';
                    setStatus('RSS è®€å–å®Œæˆï¼šç„¡æ–°è³‡æ–™', 'idle');
                    return;
                }

                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    let title = item.title;
                    let source = 'NEWS';
                    if(title.includes(']')) {
                        const parts = title.split(']');
                        source = parts[0] + ']';
                        title = parts.slice(1).join(']');
                    }

                    div.innerHTML = `
                        <span class="item-source">${source}</span>
                        <span>${title}</span>
                        <span class="item-date">${new Date(item.pubDate).toLocaleString('zh-TW', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'})}</span>
                    `;
                    div.onclick = () => {
                        editor.value = item.link;
                        setStatus(`å·²é¸å–: ${source}`, 'idle');
                    };
                    listContainer.appendChild(div);
                });
                setStatus(`RSS æ›´æ–°å®Œæˆ (${items.length} ç­†)`, 'success');
            } catch (e) { 
                console.error(e);
                setStatus('RSS è®€å–å¤±æ•— (è«‹æª¢æŸ¥ Server Log)', 'error'); 
            }
        }

        // === 3. YouTube API åŠŸèƒ½ (æ–°å¢) ===
        async function getYouTubeTrends() {
            setStatus('æ­£åœ¨é€£ç·š YouTube Data API...', 'loading');
            try {
                // å‘¼å«å¾Œç«¯ API
                const res = await fetch('/api/youtube-trending', { method: 'POST' });
                const data = await res.json();
                
                // å°‡çµæœé¡¯ç¤ºåœ¨ç·¨è¼¯å€
                editor.value = data.content;
                setStatus('YouTube ç†±æœæŠ“å–æˆåŠŸï¼', 'success');
            } catch (e) {
                console.error(e);
                setStatus('YouTube API å¤±æ•—', 'error');
                editor.value = "âš ï¸ ç„¡æ³•æŠ“å–è³‡æ–™ï¼Œè«‹æª¢æŸ¥å¾Œç«¯ Console Logã€‚";
            }
        }

        // === 4. AI åˆ†æèˆ‡å¯«ä½œ ===
        async function analyzeUrl() {
            const url = editor.value.trim();
            if(!url.startsWith('http')) return alert('è«‹å…ˆè²¼ä¸Šæœ‰æ•ˆç¶²å€');
            setStatus('AI æ­£åœ¨é–±è®€ä¸¦æ‘˜è¦...', 'loading');
            try {
                const res = await fetch('/api/summarize', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ url })
                });
                const data = await res.json();
                editor.value = data.summary;
                setStatus('æ‘˜è¦å®Œæˆ', 'success');
            } catch (e) { setStatus('åˆ†æå¤±æ•—', 'error'); }
        }

        async function generateDraft() {
            const text = editor.value;
            if(!text) return alert('ç·¨è¼¯å€ç„¡å…§å®¹');
            setStatus('AI æ­£åœ¨æ’°å¯« Gate é¢¨æ ¼è²¼æ–‡...', 'loading');
            try {
                const res = await fetch('/api/gate-draft', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ text })
                });
                const data = await res.json();
                editor.value = `${data.content}\n\nğŸ–¼ï¸ IMAGE_SRC: ${data.imageUrl}`;
                setStatus('è‰ç¨¿ç”Ÿæˆå®Œç•¢', 'success');
            } catch (e) { setStatus('ç”Ÿæˆå¤±æ•—', 'error'); }
        }

        // === 5. ç™¼å¸ƒåŠŸèƒ½ ===
        async function publish(target) {
            const raw = editor.value;
            if(!raw) return;
            if(!confirm(`ç¢ºèªç™¼å¸ƒåˆ° [${target}] ?`)) return;
            
            let content = raw;
            let imageUrl = '';
            const match = raw.match(/ğŸ–¼ï¸ IMAGE_SRC: (.*)/);
            if (match) { imageUrl = match[1]; content = raw.replace(match[0], '').trim(); }

            setStatus('æ­£åœ¨å‚³é€è‡³ Make...', 'loading');
            try {
                await fetch('/api/publish', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ target, content, imageUrl, timestamp: new Date().toISOString() })
                });
                setStatus('ğŸš€ ç™¼é€æˆåŠŸ!', 'success');
                editor.value = ''; 
            } catch (e) { setStatus('ç™¼é€å¤±æ•—', 'error'); }
        }

        // === 6. èƒŒæ™¯æ’ç¨‹è§¸ç™¼ ===
        async function triggerDaily() {
            if(!confirm('âš ï¸ ç¢ºå®šè¦æ‰‹å‹•å•Ÿå‹•ã€Œæ¯æ—¥è­°é¡Œåˆ†æã€å—ï¼Ÿ')) return;
            setStatus('å‘¼å«èƒŒæ™¯ä»»å‹™ä¸­...', 'loading');
            try {
                const res = await fetch('/api/trigger-daily', { method: 'POST' });
                const data = await res.json();
                setStatus(`âœ… ${data.message}`, 'success');
            } catch (e) { setStatus('è§¸ç™¼è«‹æ±‚å¤±æ•—', 'error'); }
        }
    </script>
</body>
</html>