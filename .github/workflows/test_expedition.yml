##########################################################################
# ğŸ§ª S-Plan åµå¯Ÿå…µç«åŠ›æ¸¬è©¦ (Expedition Module - é›™ç¶­åº¦ç‰ˆ)
# ä»»å‹™ï¼šæ¸¬è©¦å„ä¾›æ‡‰å•†å° Podbay æˆ– Listen Notes çš„ç©¿é€åŠ›
##########################################################################
name: ğŸ§ª S-Plan Scanner Test

on:
  workflow_dispatch:
    inputs:
      test_provider:
        description: 'ğŸ§ª é¸æ“‡æ¬²æ¸¬è©¦çš„åµå¯Ÿéƒ¨éšŠ (ä¾›æ‡‰å•†)'
        required: true
        default: 'ZENROWS'
        type: choice
        options: 
          - ZENROWS
          - WEBSCRAPING
          - SCRAPEDO
          - HASDATA
      # ä¸€è¡Œè¨»è§£ï¼šæ–°å¢ç›®æ¨™ç¶²ç«™é¸å–®ï¼Œè®“æŒ‡æ®å®˜æ±ºå®šé€²æ”»å“ªä¸€å€‹æƒ…å ±ç«™é»ã€‚
      test_site:
        description: 'ğŸ¯ é¸æ“‡åµå¯Ÿç›®æ¨™ç«™é»'
        required: true
        default: 'PODBAY'
        type: choice
        options:
          - PODBAY
          - LISTEN_NOTES

jobs:
  scanner_expedition:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
      R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
      
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      
      SCRAP_API_KEY: ${{ secrets.SCRAP_API_KEY }}
      ZENROWS_API_KEY: ${{ secrets.ZENROWS_API_KEY }}
      WEBSCRAP_API_KEY: ${{ secrets.WEBSCRAP_API_KEY }}
      SCRAPEDO_API_KEY: ${{ secrets.SCRAPEDO_API_KEY }}
      HASDATA_API_KEY: ${{ secrets.HASDATA_API_KEY }}

      RENDER_WEBHOOK_URL: ${{ secrets.RENDER_WEBHOOK_URL }}
      CRON_SECRET: ${{ secrets.CRON_SECRET }}
      
      # ğŸ¯ å°‡ YML é¸å–®çµæœæ˜ å°„è‡³ Python è®€å–çš„è®Šæ•¸åç¨±
      TEST_PROVIDER_MODE: ${{ github.event.inputs.test_provider }}
      # ä¸€è¡Œè¨»è§£ï¼šå°‡é¸å–®é¸ä¸­çš„ç«™é»ï¼ˆPODBAY/LISTEN_NOTESï¼‰å‚³éçµ¦ Python è…³æœ¬ã€‚
      TEST_SITE_TARGET: ${{ github.event.inputs.test_site }}
      PYTHONUNBUFFERED: 1

    steps:
    - name: ğŸ“¦ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4

    - name: ğŸ è¨­å®š Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: âš™ï¸ å®‰è£ç’°å¢ƒä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 supabase python-dotenv boto3

    - name: ğŸ¯ ç™¼å‹•åµå¯Ÿæ¼”ç¿’ (Expedition)
      run: |
        echo "ğŸš€ [ç™¼å‹•] ä¾›æ‡‰å•†ï¼š$TEST_PROVIDER_MODE | ç›®æ¨™ç«™é»ï¼š$TEST_SITE_TARGET"
        python src/test_scanner_expedition.py