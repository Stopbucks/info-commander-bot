##########################################################################
# ğŸ§ª S-Plan åµå¯Ÿå…µç«åŠ›æ¸¬è©¦ (Expedition Module)
# ä»»å‹™ï¼šæ¸¬è©¦å„ä¾›æ‡‰å•†ç©¿é€åŠ›ï¼Œä¸¦æ¶ˆåŒ– Supabase å¾…å‘½ (Pending) ä»»å‹™
# è¨»ï¼šæ­¤ç‚ºæ‹‹æ£„å¼æ¸¬è©¦æª”ï¼Œä¸å«å®šæ™‚æ’ç¨‹ï¼Œåƒ…é™æ‰‹å‹•è§¸ç™¼ã€‚
##########################################################################
name: ğŸ§ª S-Plan Scanner Test

on:
  workflow_dispatch:
    inputs:
      test_provider:
        description: 'ğŸ§ª é¸æ“‡æ¬²æ¸¬è©¦çš„åµå¯Ÿéƒ¨éšŠ (ä¾›æ‡‰å•†)'
        required: true
        default: 'ZENROWS'
        type: choice
        options: 
          - ZENROWS
          - WEBSCRAPING
          - SCRAPEDO
          - HASDATA

jobs:
  scanner_expedition:
    runs-on: ubuntu-latest
    timeout-minutes: 30 # æ¸¬è©¦ä»»å‹™è¨­å®š 30 åˆ†é˜å³å¯

    # ğŸš€ ç¹¼æ‰¿ä¸»æµç¨‹æ‰€æœ‰æˆ°ç•¥é‡‘é‘°
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
      R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
      
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      
      SCRAP_API_KEY: ${{ secrets.SCRAP_API_KEY }}
      ZENROWS_API_KEY: ${{ secrets.ZENROWS_API_KEY }}
      WEBSCRAP_API_KEY: ${{ secrets.WEBSCRAP_API_KEY }}
      SCRAPEDO_API_KEY: ${{ secrets.SCRAPEDO_API_KEY }}
      HASDATA_API_KEY: ${{ secrets.HASDATA_API_KEY }} # ğŸš€ è«‹ç¢ºä¿ GitHub Secrets å·²æ–°å¢æ­¤é …

      RENDER_WEBHOOK_URL: ${{ secrets.RENDER_WEBHOOK_URL }}
      CRON_SECRET: ${{ secrets.CRON_SECRET }}
      
      # ğŸ¯ å‚³éæ¸¬è©¦æŒ‡ä»¤çµ¦ Python
      TEST_PROVIDER_MODE: ${{ github.event.inputs.test_provider }}
      PYTHONUNBUFFERED: 1

    steps:
    - name: ğŸ“¦ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4

    - name: ğŸ è¨­å®š Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: âš™ï¸ å®‰è£ç’°å¢ƒä¾è³´
      # ä¸€è¡Œè¨»è§£ï¼šå®‰è£å¿…è¦çš„ Python å‡½å¼åº«ä»¥é€²è¡Œç¶²é æƒæèˆ‡è³‡æ–™åº«æ“ä½œã€‚
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 supabase python-dotenv boto3

    - name: ğŸ¯ ç™¼å‹•åµå¯Ÿæ¼”ç¿’ (Expedition)
      # ä¸€è¡Œè¨»è§£ï¼šå‘¼å«ç¨ç«‹æ¸¬è©¦è…³æœ¬ï¼Œé ˜å– 3 ç­†ä»»å‹™é€²è¡Œç‰¹å®šä¾›æ‡‰å•†ç©¿é€æ¸¬è©¦ã€‚
      run: |
        echo "ğŸš€ [ç™¼å‹•] æ­£åœ¨æ¸¬è©¦ä¾›æ‡‰å•†ï¼š$TEST_PROVIDER_MODE"
        python src/test_scanner_expedition.py