##########################################################################
# ğŸ“¡ S-Plan é€šè¨Šéˆè·¯è¨ºæ–· (Handoff Discovery Module - å®‰å…¨å¼·åŒ–ç‰ˆ)
# ä»»å‹™ï¼šæ¸¬è©¦é€šè¨Šæ´»æ€§ï¼Œä¸¦ç¢ºä¿åœ¨å…¬é–‹å€‰åº«ä¸­ä¸ç•™æŒ‡ç´‹ã€‚
##########################################################################
name: ğŸ“¡ S-Plan Handoff Diagnostic

on:
  # ğŸš€ æ¨¡ç³ŠåŒ–å¤–éƒ¨è§¸ç™¼åç¨±
  repository_dispatch:
    types: [diag_trigger]

  # ğŸ› ï¸ æ‰‹å‹•æ¸¬è©¦å•Ÿå‹•
  workflow_dispatch:
    inputs:
      test_target:
        description: 'ğŸ¯ æ¨¡å¼é¸æ“‡'
        required: true
        default: 'MODE_ALL'
        type: choice
        options:
          - MODE_ALL
          - MODE_A

jobs:
  diagnostic_call:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: ğŸ“¦ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4

    - name: ğŸ è¨­å®š Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: âš™ï¸ å®‰è£è¼•é‡åŒ–ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install requests python-dotenv

    - name: ğŸ“¡ åŸ·è¡Œé€šè¨Šæ•ˆèƒ½æ ¡é©—
      env:
        # ä¸€è¡Œè¨»è§£ï¼šæ¡ç”¨æŠ½è±¡æ˜ å°„åç¨±ï¼Œéš±è— Secret åŸå§‹ç”¨é€”ã€‚
        TARGET_A: ${{ secrets.RENDER_WEBHOOK_URL }}
        TOKEN_A: ${{ secrets.CRON_SECRET }}
        RUN_MODE: ${{ github.event.inputs.test_target || 'MODE_ALL' }}
        PYTHONUNBUFFERED: 1
      run: |
        echo "ğŸš€ [å•Ÿå‹•] åŸ·è¡Œå”è­°æ¸¬è©¦ï¼Œç•¶å‰æ¨¡å¼: $RUN_MODE"
        python src/test_handoff_call.py