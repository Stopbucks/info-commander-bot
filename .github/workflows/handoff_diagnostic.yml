##########################################################################
# ğŸ“¡ S-Plan é€šè¨Šéˆè·¯è¨ºæ–· (Handoff Discovery Module)
# ä»»å‹™ï¼šæ¸¬è©¦ RENDER_WEBHOOK_URL èˆ‡ CRON_SECRET çš„é€šè¨Šæ´»æ€§ï¼Œæ‰¾å‡º 404 çœŸå…‡ã€‚
##########################################################################
name: ğŸ“¡ S-Plan Handoff Diagnostic

on:
  # ğŸš€ æ”¯æ´å¤–éƒ¨ API è§¸ç™¼ (å¯ç”± cron-job.org æˆ–å…¶ä»–æ¸¬è©¦æºå•Ÿå‹•)
  repository_dispatch:
    types: [handoff_test]

  # ğŸ› ï¸ æ‰‹å‹•æ¸¬è©¦å•Ÿå‹• (GitHub UI)
  workflow_dispatch:
    inputs:
      test_target:
        description: 'ğŸ¯ é¸æ“‡æ¸¬è©¦ç›®æ¨™'
        required: true
        default: 'BOTH'
        type: choice
        options:
          - BOTH          # åŒæ™‚æ¸¬è©¦ Webhook èˆ‡ Secret
          - WEBHOOK_ONLY  # åªæ¸¬è©¦ RENDER_WEBHOOK_URL
          - SECRET_ONLY   # åªæ¸¬è©¦ CRON_SECRET + VERCEL_SCOUT

jobs:
  diagnostic_call:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # è¨ºæ–·ä»»å‹™ä¸æ‡‰è¶…é 10 åˆ†é˜

    steps:
    - name: ğŸ“¦ æª¢å‡ºè¨ºæ–·ç¨‹å¼ç¢¼
      uses: actions/checkout@v4

    - name: ğŸ è¨­å®š Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: âš™ï¸ å®‰è£è¼•é‡åŒ–ä¾è³´
      # ä¸€è¡Œè¨»è§£ï¼šåƒ…å®‰è£é€šè¨Šå¿…éœ€åº« requestsï¼Œç¯€çœéƒ¨ç½²è³‡æºã€‚
      run: |
        python -m pip install --upgrade pip
        pip install requests python-dotenv

    - name: ğŸ“¡ ç™¼å‹•é€šè¨Šç«åŠ›åµå¯Ÿ (Handoff Test)
      env:
        # ä¸€è¡Œè¨»è§£ï¼šå°å…¥æ¸…å–®ä¸­çš„æ ¸å¿ƒé€šè¨Šå¯†é‘°ã€‚
        RENDER_WEBHOOK_URL: ${{ secrets.RENDER_WEBHOOK_URL }}
        CRON_SECRET: ${{ secrets.CRON_SECRET }}
        VERCEL_SCOUT_URL: ${{ secrets.VERCEL_SCOUT_URL }}
        TEST_TARGET: ${{ github.event.inputs.test_target || 'BOTH' }}
        PYTHONUNBUFFERED: 1
      run: |
        echo "ğŸš€ [å•Ÿå‹•] é€šè¨Šè¨ºæ–·æ¨¡å¼: $TEST_TARGET"
        # åŸ·è¡Œæˆ‘å€‘ä¹‹å‰é æ“¬çš„æ¸¬è©¦è…³æœ¬
        python src/test_handoff_call.py