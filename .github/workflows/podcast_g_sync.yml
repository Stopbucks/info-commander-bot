##########################################################################
# ğŸª– PODCAST GUERRILLA G-SQUAD (æ¸¸æ“Šéƒ¨éšŠè‡ªå‹•åŒ–ï¼šOpus + Groq ç‰ˆ)
##########################################################################
# 1. æŒ‡æ®æ¬Šé™ï¼šç”± GitHub Actions å…§éƒ¨ Schedule è§¸ç™¼ã€‚
# 2. å‡ºå‹¤é€±æœŸï¼šå°åŒ—æ™‚é–“ é€±ä¸€ã€ä¸‰ã€äº”ã€æ—¥ å‡Œæ™¨ 03:00 (UTC 19:00)ã€‚
# 3. æ ¸å¿ƒç‰¹å¾µï¼šç¨ç«‹ Proxy å‡ºå£ã€Opus æ¥µé™å£“ç¸®ã€Groq æ¥µé€Ÿæ‘˜è¦ã€‚
##########################################################################

name: Podcast Guerrilla Squad Sync

on:
  schedule:
    # ğŸš€ å°åŒ— 03:00 (ä¸€ã€ä¸‰ã€äº”ã€æ—¥) = UTC 19:00 (æ—¥ã€äºŒã€å››ã€å…­)
    # Cron ç´¢å¼•ï¼š0=Sun, 2=Tue, 4=Thu, 6=Sat
    - cron: '0 19 * * 0,2,4,6'
  
  # ğŸ› ï¸ æ”¯æ´æ‰‹å‹•å¾ Actions ä»‹é¢é»æ“Šè§¸ç™¼
  workflow_dispatch:

jobs:
  guerrilla_hit:
    runs-on: ubuntu-latest
    timeout-minutes: 150 # è€ƒæ…®åˆ° 20 åˆ†é˜çš„ä»»å‹™é–“ä¼‘æ¯èˆ‡æ“¬æ…‹é–±è®€ï¼Œçµ¦äºˆå……è¶³æ™‚é•·

    env:
      PYTHONUNBUFFERED: 1
      # ğŸ” [æ¸¸æ“ŠéšŠå°ˆå±¬] ä»£ç†èˆ‡ AI å¯†é‘°
      WEBSHARE_LIST: ${{ secrets.WEBSHARE_LIST }}
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }} # ğŸš€ æ–°å¢
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}     # ğŸš€ æ–°å¢
      # ğŸ” [åŸºç¤è¨­æ–½] å…±äº«è³‡æ–™åº«èˆ‡ Webhook
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      RENDER_WEBHOOK_URL: ${{ secrets.RENDER_WEBHOOK_URL }}
      GCP_SERVICE_ACCOUNT_JSON: ${{ secrets.GCP_SERVICE_ACCOUNT_JSON }}

    steps:
      - name: ğŸ“¦ [éƒ¨ç½²] æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ [ç’°å¢ƒ] è¨­å®š Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: âš™ï¸ [è£å‚™] å®‰è£ç³»çµ±ä¾è³´ (FFmpeg/Opus) èˆ‡ Python åº«
        run: |
          # ğŸš€ é—œéµï¼šå®‰è£ libopus-dev ä»¥æ”¯æ´ 16k Mono Opus è½‰ç¢¼
          sudo apt-get update && sudo apt-get install -y ffmpeg libopus-dev
          python -m pip install --upgrade pip
          # å®‰è£åŒ…å« Groq èˆ‡ Supabase åœ¨å…§çš„å¿…è¦å¥—ä»¶
          pip install "curl_cffi>=0.7.0" "requests[socks]" feedparser google-generativeai groq PySocks python-dotenv supabase google-cloud-storage
      - name: âš”ï¸ [çªæ“Š] å•Ÿå‹• g-å°éšŠé ˜å‘½ä»»å‹™
        run: |
          echo "ğŸ“… ç³»çµ±å•Ÿå‹•æ™‚é–“ (UTC): $(date -u)"
          python src/podcast_g_proc.py

      - name: ğŸ§¹ [æ¸…ç†] ä»»å‹™çµæ¡ˆä¸¦ç§»é™¤æ®˜ç•™éŸ³æª”
        if: always()
        run: |
          rm -f *.mp3 *.opus
          echo "ğŸ æ¸¸æ“Šç¾å ´æ¸…ç†å®Œç•¢ï¼Œæ•¸æ“šå·²å›å¡«é›²ç«¯ã€‚"