##########################################################################
# ğŸ¹ INFO COMMANDER æ•‘æ´ä¸­å¿ƒ v1.0 (æ·±å¤œè£œæª”ç‰ˆ)
##########################################################################
# 1. ä»»å‹™ç›®æ¨™ï¼šå°ˆè²¬è™•ç†  å¤±æ•—ä»»å‹™æˆ–æ¬¡æ–°é›† (Penultimate) ä¸‹è¼‰ã€‚
# 2. è§¸ç™¼æ©Ÿåˆ¶ï¼šç”± cron-job.org æ–¼å°åŒ— 03:00 (UTC 19:00) è§¸ç™¼ã€‚
##########################################################################

name: Info Commander Rescue Task

on:
  # ğŸš€ å¤–éƒ¨ API è§¸ç™¼é» (dispatch type: rescue_mission)
  repository_dispatch:
    types: [rescue_mission]

  # ğŸ› ï¸ æ‰‹å‹•å•Ÿå‹•æ•‘æ´ç¨‹åº
  workflow_dispatch:

jobs:
  rescue_ops:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # ğŸš€ åŒæ¨£çµ¦äºˆ 3 å°æ™‚ï¼Œç¢ºä¿é•·å»¶é²ä¸‹è¼‰ä¸è¢«ä¸­æ–·
    
    # ================= [æ•‘æ´ä¸­å¿ƒï¼šæ™ºæ…§åˆ†æµå€å¡Š] =================

    steps:
    - name: ğŸ“¦ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4

    - name: ğŸ è¨­å®š Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    # ğŸš€ [æ ¸å¿ƒæ‰‹è¡“]ï¼šæ”¹ç‚ºå°éšŠåˆ¤å®šï¼Œæ•‘æ´æ—¥ (Index 5) çš„ RE è·¯å¾‘é è¨­é—œé–‰ WARP
    - name: ğŸ” æ•‘æ´ç’°å¢ƒåˆ¤å®š (Rescue Triage)
      id: triage
      run: |
        # å–å¾— UTC 19:00 (å°åŒ— 03:00) ç•¶æ™‚çš„æ˜ŸæœŸç´¢å¼•
        WEEK_INDEX=$(($(date -u +%u) - 1))
        
        # è®€å– JSON é…ç½®
        PATH_ID=$(jq -r ".squad_config[\"$WEEK_INDEX\"].path_id" config/podcast_tactics.json)
        TEAM_NAME=$(jq -r ".squad_config[\"$WEEK_INDEX\"].team" config/podcast_tactics.json)
        
        echo "ğŸ“… æ•‘æ´ä»»å‹™ç´¢å¼•: $WEEK_INDEX | åŸ·è¡Œå°éšŠ: $TEAM_NAME | è·¯å¾‘: $PATH_ID"

        # æˆ°è¡“é‚è¼¯ï¼šåªæœ‰ç´” GitHub ç›´é€£ (D) æ‰éœ€è¦ WARPã€‚
        # æ•‘æ´å…µ (RE) èˆ‡ Fly (A, C) å‡ä¸éœ€ WARPï¼Œä»¥é¿å…èˆ‡ GCP+WARP ç‰¹å¾µé‡ç–Š [cite: 2026-02-06]
        if [[ "$PATH_ID" == "D" ]]; then
          echo "NEED_WARP=true" >> $GITHUB_ENV
          echo "ğŸ›¡ï¸ [åˆ¤å®š] åµæ¸¬åˆ°ç›´é€£è·¯å¾‘ï¼Œå•Ÿå‹• WARP éš±èº«æ–—ç¯·ã€‚"
        else
          echo "NEED_WARP=false" >> $GITHUB_ENV
          echo "ğŸ­ [åˆ¤å®š] åµæ¸¬åˆ°å°ˆæ¥­ä»£ç†è·¯å¾‘ ($PATH_ID)ï¼Œè·³é WARP ä»¥é™ä½å»¶é²ã€‚"
        fi

    - name: ğŸ›¡ï¸ éƒ¨ç½² Cloudflare WARP éš±èº«æ–—ç¯·
      if: env.NEED_WARP == 'true'
      uses: fscarmen/warp-on-actions@v1.1
      with:
        stack: nosh

    - name: ğŸ”Œ ç­‰å¾… WARP æœå‹™ç©©å®š
      if: env.NEED_WARP == 'true'
      run: |
        echo "â³ æ­£åœ¨ç‚ºæ•‘æ´éƒ¨éšŠé ç†±ç’°å¢ƒ..."
        sleep 10
        sudo warp-cli --accept-tos status || (sudo systemctl restart warp-svc && sleep 5)

    - name: âš™ï¸ å®‰è£æ•‘æ´ç’°å¢ƒèˆ‡ä¾è³´
      run: |
        sudo apt-get update && sudo apt-get install -y ffmpeg
        python -m pip install --upgrade pip
        pip install --force-reinstall supabase curl_cffi>=0.7.0 requests[socks] feedparser google-generativeai groq PySocks sgmllib3k python-dotenv google-cloud-storage

    - name: ğŸš€ åŸ·è¡Œä»»å‹™ (Run Info Commander)
      env:
        # --- æ ¸å¿ƒ API é‡‘é‘° ---
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        RENDER_WEBHOOK_URL: ${{ secrets.RENDER_WEBHOOK_URL }}
        CRON_SECRET: ${{ secrets.CRON_SECRET }}
        
        
        # --- ğŸš€ GCP é›²ç«¯å¤§è…¦é‡‘é‘° (ç”¨æ–¼åŒæ­¥ Cookies èˆ‡æŒ‡ç´‹åº«) ---
        GCP_SERVICE_ACCOUNT_JSON: ${{ secrets.GCP_SERVICE_ACCOUNT_JSON }}
        
        # ğŸ” [æ ¸å¿ƒå¯†é‘°] è£œä¸Šç¼ºå¤±çš„ Supabase é‘°åŒ™
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}

        # --- ä»£ç†è·¯å¾‘å®‰å…¨è®Šæ•¸ ---
        VPS_PROXY_URL: ${{ secrets.VPS_PROXY_URL }}
        PROXY_LIST: ${{ secrets.PROXY_LIST }}
        GCP_PROXY_USER: ${{ secrets.GCP_PROXY_USER }}
        GCP_PROXY_PASS: ${{ secrets.GCP_PROXY_PASS }}
        GCP_PROXY_HOST: ${{ secrets.GCP_PROXY_HOST }}
        GCP_PROXY_PORT: ${{ secrets.GCP_PROXY_PORT }}
        
        # ğŸ‘‡ [FLY å°ˆç”¨è®Šæ•¸] --------------------------------
        FLY_PROXY_JP: ${{ secrets.FLY_PROXY_JP }}
        FLY_PROXY_LA: ${{ secrets.FLY_PROXY_LA }}
        FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        
        # --------------------------------------------------
        # ğŸš€ æ•‘æ´å°éšŠå°ˆç”¨è®Šæ•¸
        #SCRAPER_API_KEY: ${{ secrets.SCRAPER_API_KEY }}
        WEBSHARE_LIST: ${{ secrets.WEBSHARE_LIST }} 
        SCRAP_API_KEY: ${{ secrets.SCRAP_API_KEY }}
        PYTHONUNBUFFERED: 1
      run: |
        echo "ğŸš€ æ•‘æ´å°éšŠå‡ºå‹¤æ™‚é–“: $(date -u)"
        # ğŸ’¡ åŸ·è¡Œæˆ‘å€‘æ–°å‰µç«‹çš„æ•‘æ´è…³æœ¬
        python src/podcast_rescuer.py