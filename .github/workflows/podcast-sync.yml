##########################################################################
# ğŸš€ INFO COMMANDER æŒ‡æ®ä¸­å¿ƒ v2.6 (å¤–éƒ¨ç²¾æº–è§¸ç™¼ç‰ˆ)
##########################################################################
# 1. æŒ‡æ®æ¬Šé™è®Šæ›´ï¼š
#    - [ç§»é™¤] GitHub å…§éƒ¨ Scheduleï¼šé¿å…æ’ç¨‹å»¶é²èˆ‡é‡è¤‡åŸ·è¡Œè¡çªã€‚
#    - [å•Ÿç”¨] å¤–éƒ¨ç²¾æº–å•Ÿå‹•ï¼šå®Œå…¨ç”± cron-job.org é€é API è§¸ç™¼ã€‚
# 2. è¡Œç‚ºç‰¹å¾µï¼š
#    - å•Ÿå‹•ç²¾æº–åº¦ï¼š100% (ç”± cron-job.org ä¿è­‰)ã€‚
#    - å ±åˆ°éš¨æ©Ÿæ€§ï¼šç”± Python å…§éƒ¨ Jitter é‚è¼¯åŸ·è¡Œ (ä¼ºæœå™¨ç«¯çœ‹ä¸åˆ°æº–é»è¡Œç‚º)ã€‚
#    - 0231 ç”±supabaseæ“”ä»»é›²ç«¯ç™¼æ´¾ç¯€ç›®æ›´æ–°
##########################################################################

name: Info Commander Podcast Sync

on:
  # ğŸš€ å¤–éƒ¨ API è§¸ç™¼é» (ä¾› cron-job.org ä½¿ç”¨)
  repository_dispatch:
    types: [weekday_lite_task]

  # ğŸ› ï¸ æ‰‹å‹•æ¸¬è©¦å•Ÿå‹•
  workflow_dispatch:
    inputs:
      task_type:
        description: 'é¸æ“‡åŸ·è¡Œæ¨¡å¼'
        required: true
        default: 'standard_run'
        type: choice
        options:
          - standard_run      # ä¾ç…§ JSON æ’ç¨‹åŸ·è¡Œ
          - network_check     # åŸ·è¡Œå…¨æ–¹ä½ä»£ç†å¥æª¢ (Medic ç‰ˆ)
          - force_run_all     # å¼·åˆ¶æƒææ¨¡å¼
jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # ğŸš€ æ”¯æ’æ“¬æ…‹é•·ä¼‘æ¯ï¼Œçµ¦äºˆå……è¶³çš„3å°æ™‚æ‰é—œæ©Ÿ
    
    steps:
    - name: ğŸ“¦ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4

    - name: ğŸ è¨­å®š Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
    
    - name: âš™ï¸ å®‰è£ç³»çµ±èˆ‡ Python ä¾è³´
      run: |
        sudo apt-get update && sudo apt-get install -y ffmpeg
        python -m pip install --upgrade pip
        # å®‰è£åŒ…å« GCP å„²å­˜èˆ‡ TLS æ“¬æ…‹æ‰€éœ€çš„åº«
        # ğŸš€ [æ›´æ–°] åŠ å…¥ supabase å‡½å¼åº«ï¼Œè§£æ±º ModuleNotFoundError
        pip install "curl_cffi>=0.7.0" "requests[socks]" feedparser google-generativeai groq PySocks sgmllib3k python-dotenv google-cloud-storage supabase

    # ================= [å€å¡Š Aï¼šä¿®æ­£å¾Œçš„ç²¾æº–åˆ†æµé‚è¼¯] =================
    - name: ğŸ” å°éšŠç’°å¢ƒåˆ¤å®š (Squad Triage)
      id: triage
      run: |
        # 1. å–å¾—ç•¶å‰ UTC æ˜ŸæœŸç´¢å¼• (0=Mon, 6=Sun)
        WEEK_INDEX=$(($(date -u +%u) - 1))
        
        # 2. è®€å–ä»Šæ—¥å°éšŠé…ç½®
        PATH_ID=$(jq -r ".squad_config[\"$WEEK_INDEX\"].path_id" config/podcast_tactics.json)
        TEAM_NAME=$(jq -r ".squad_config[\"$WEEK_INDEX\"].team" config/podcast_tactics.json)
        RUN_MODE="${{ github.event.client_payload.task_type || github.event.inputs.task_type || 'standard_run' }}"
        
        echo "ğŸ“… ä»Šæ—¥ UTC ç´¢å¼•: $WEEK_INDEX | å°éšŠ: $TEAM_NAME | è·¯å¾‘: $PATH_ID"

        # ğŸš€ [æ ¸å¿ƒå„ªåŒ–]ï¼šæ¸¬è©¦æ¨¡å¼ä¸å†å¼·åˆ¶å•Ÿå‹• WARP
        # é‚è¼¯ï¼šåªæœ‰ç´” GitHub ç›´é€£ (D) èˆ‡éœ€ä¸­è½‰çš„ GCP (B) æ‰å•Ÿå‹•æ–—ç¯·ã€‚ 
        if [[ "$PATH_ID" =~ ^(B|D)$ ]]; then
          echo "NEED_WARP=true" >> $GITHUB_ENV
          echo "ğŸ›¡ï¸ [åˆ¤å®š] $TEAM_NAME ($PATH_ID) éœ€éš±èº«ä¿è­·ï¼Œå•Ÿå‹• WARPã€‚"
        else
          echo "NEED_WARP=false" >> $GITHUB_ENV
          echo "ğŸ­ [åˆ¤å®š] $TEAM_NAME ($PATH_ID) å…·å‚™å°ˆæ¥­ä»£ç†æˆ–ç‚ºåŸç”Ÿç’°å¢ƒï¼Œè·³é WARPã€‚"
        fi

    # ğŸš€ [å€å¡Š B]ï¼šæ¢ä»¶å¼éƒ¨ç½² (åƒ…åœ¨ NEED_WARP ç‚º true æ™‚åŸ·è¡Œ)
    - name: ğŸ›¡ï¸ éƒ¨ç½² Cloudflare WARP éš±èº«æ–—ç¯·
      if: env.NEED_WARP == 'true'
      uses: fscarmen/warp-on-actions@v1.1
      with:
        stack: nosh

    # ğŸš€ [å€å¡Š C]ï¼šæ¢ä»¶å¼é ç†± (åƒ…åœ¨ NEED_WARP ç‚º true æ™‚åŸ·è¡Œ)
    # ========== [å€å¡Š Cï¼šå…·å‚™è¶…æ™‚æ§åˆ¶çš„å°±ç·’è‡ªæª¢] =========
    - name: ğŸ”Œ ç­‰å¾… WARP æœå‹™å°±ç·’ä¸¦é©—è­‰ç¶²è·¯
      if: env.NEED_WARP == 'true'
      run: |
        echo "â³ æ­£åœ¨åˆå§‹åŒ– WARP ç¶²è·¯ç’°å¢ƒ..."
        # 1. çµ¦äºˆåŸºç¤ç·©è¡
        sleep 10 
        
        # 2. å¼·åˆ¶æª¢æŸ¥ç‹€æ…‹ (é™æ™‚ 15 ç§’)
        if ! timeout 15s sudo warp-cli --accept-tos status; then
          echo "âš ï¸ WARP ç‹€æ…‹æª¢æŸ¥é€¾æ™‚ï¼Œå˜—è©¦é‡å•Ÿæœå‹™..."
          sudo systemctl restart warp-svc
          sleep 5
        fi

        # ğŸš€ [é˜²å¡æ­»è¨­è¨ˆ]ï¼šä½¿ç”¨ç¨ç«‹çš„ timeout åŸ·è¡Œæª¢æ¸¬ï¼Œä¸åŒ…åœ¨ echo å…§
        echo "ğŸ“¡ æ­£åœ¨åµæ¸¬å‡ºå£ IP (æ´—æ»Œå¾Œ)..."
        # ä½¿ç”¨ç³»çµ± timeout 15ç§’ï¼Œå³ä½¿ç¶²è·¯æ–·æ‰ä¹Ÿæœƒåœ¨ 15 ç§’å…§å¼·åˆ¶çµæŸ
        timeout 15s curl -s4 --retry 1 https://api.ip.sb/geoip || echo "âš ï¸ å‡ºå£åµæ¸¬é€¾æ™‚ï¼Œå°‡å˜—è©¦ç›´æ¥åŸ·è¡Œä»»å‹™ã€‚"
#---[å€å¡Š C]ï¼šæ¢ä»¶å¼é ç†±å‰é¢ç¨‹å¼ç¢¼ç›¸åŒ---#
# -----(å®šä½ç·š)ä»¥ä¸‹ä¿®æ”¹----
    - name: â³ é›™æ©Ÿè¯å‹•æ·±åº¦é ç†± (Fly.io Dual-Node Warmup)
      if: env.NEED_WARP == 'false'
      run: |
        echo "ğŸš€ å•Ÿå‹•é›™ç¯€é»å–šé†’ç¨‹åºï¼Œç›®æ¨™ï¼šLAX (ç¾åœ‹) èˆ‡ NRT (æ—¥æœ¬)"
        
        # é€²è¡Œæœ€å¤š 10 æ¬¡å¾ªç’°ï¼Œç¸½æ™‚é•·ç´„ 200 ç§’
        for i in {1..10}; do
          echo "ğŸ“¡ ç¬¬ $i æ¬¡å–šé†’å˜—è©¦ (Dual-Probe)..."
          
          # åŒæ™‚è¸¢é†’å…©å°æ©Ÿå™¨ (ä¸è«–çµæœï¼Œå…ˆç™¼ä¿¡è™Ÿ)
          curl -I -m 5 --proxy "${{ secrets.FLY_PROXY_LA }}" https://www.google.com > /dev/null 2>&1 || true
          curl -I -m 5 --proxy "${{ secrets.FLY_PROXY_JP }}" https://www.google.com > /dev/null 2>&1 || true
          
          # é©—è­‰ä»Šæ—¥ç›®æ¨™è·¯å¾‘æ˜¯å¦å·²ç¶“å°±ç·’
          # ğŸ’¡ é€™è£¡æœƒæ ¹æ“š triage æ­¥é©Ÿå¾—åˆ°çš„ PATH_ID å‹•æ…‹æ±ºå®šæª¢æŸ¥å“ªä¸€é‚Š
          CHECK_PROXY=""
          if [[ "${{ env.PATH_ID }}" == "C" ]]; then CHECK_PROXY="${{ secrets.FLY_PROXY_LA }}"; fi
          if [[ "${{ env.PATH_ID }}" == "E" ]]; then CHECK_PROXY="${{ secrets.FLY_PROXY_JP }}"; fi
          
          # å¦‚æœæˆåŠŸé€éä»£ç†é€£ç·šï¼Œå‰‡ææ—©çµæŸç­‰å¾…
          if [ -n "$CHECK_PROXY" ] && curl -I -m 10 --proxy "$CHECK_PROXY" https://www.google.com > /dev/null 2>&1; then
            echo "âœ… ç›®æ¨™ç¯€é» ${{ env.PATH_ID }} å·²æˆåŠŸå°±ç·’ï¼"
            break
          fi
          
          if [ $i -eq 10 ]; then
            echo "âš ï¸ å·²é”åˆ° 200 ç§’ä¸Šé™ï¼Œä»»å‹™å°‡åœ¨ä¸ç©©å®šç‹€æ…‹ä¸‹å•Ÿå‹•ã€‚"
          else
            echo "ğŸ’¤ ç¯€é»å•Ÿå‹•ä¸­ï¼Œç­‰å¾… 20 ç§’å¾Œé€²è¡Œä¸‹ä¸€è¼ªæƒæ..."
            sleep 20
          fi
        done
#---ä¸‹ä¸€æ­¥å°±æ˜¯åŸ·è¡Œä»»å‹™---#

    - name: ğŸš€ åŸ·è¡Œä»»å‹™ (Run Info Commander)
      env:
        # --- æ ¸å¿ƒ API é‡‘é‘° ---
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        RENDER_WEBHOOK_URL: ${{ secrets.RENDER_WEBHOOK_URL }}
        CRON_SECRET: ${{ secrets.CRON_SECRET }}
        
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }} # ğŸš€ æ–°å¢
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}     # ğŸš€ æ–°å¢
        # --- ğŸš€ GCP é›²ç«¯å¤§è…¦é‡‘é‘° (ç”¨æ–¼åŒæ­¥ Cookies èˆ‡æŒ‡ç´‹åº«) ---
        GCP_SERVICE_ACCOUNT_JSON: ${{ secrets.GCP_SERVICE_ACCOUNT_JSON }}
        
        # --- ä»£ç†è·¯å¾‘å®‰å…¨è®Šæ•¸ ---
        VPS_PROXY_URL: ${{ secrets.VPS_PROXY_URL }}
        PROXY_LIST: ${{ secrets.PROXY_LIST }}
        GCP_PROXY_USER: ${{ secrets.GCP_PROXY_USER }}
        GCP_PROXY_PASS: ${{ secrets.GCP_PROXY_PASS }}
        GCP_PROXY_HOST: ${{ secrets.GCP_PROXY_HOST }}
        GCP_PROXY_PORT: ${{ secrets.GCP_PROXY_PORT }}
        
        # ğŸ‘‡ [FLY å°ˆç”¨è®Šæ•¸] --------------------------------
        FLY_PROXY_JP: ${{ secrets.FLY_PROXY_JP }}
        FLY_PROXY_LA: ${{ secrets.FLY_PROXY_LA }}
        FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        # --------------------------------------------------
        # ğŸš€ æ•‘æ´å°éšŠå°ˆç”¨è®Šæ•¸
        SCRAPER_API_KEY: ${{ secrets.SCRAPER_API_KEY }}
        WEBSHARE_LIST: ${{ secrets.WEBSHARE_LIST }}
        SCRAP_API_KEY: ${{ secrets.SCRAP_API_KEY }}
        PYTHONUNBUFFERED: 1
        # è‡ªå‹•æŠ“å–å¤–éƒ¨å‚³å…¥çš„åŸ·è¡Œæ¨¡å¼
        RUN_MODE: ${{ github.event.client_payload.task_type || github.event.inputs.task_type || 'standard_run' }}
      
      run: |
        if [ "${{ env.RUN_MODE }}" == "network_check" ]; then
          echo "ğŸ” å•Ÿå‹•å…¨æ–¹ä½è¨ºæ–·ï¼šPodcast Proxy Medic..."
          python src/podcast_proxy_medic.py

        else
          echo "ğŸš€ åŸ·è¡Œæ¨¡å¼: ${{ env.RUN_MODE }} | ç³»çµ±æ™‚é–“: $(date -u)"
          # ğŸ’¡ å·²å°é½Šï¼šæ­¤æ™‚å‚³å…¥çš„æ˜¯ UTC ç³»çµ±æ™‚é–“
          python src/podcast_processor.py
        fi