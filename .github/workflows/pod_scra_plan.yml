##########################################################################
# ğŸƒ S-Plan 4.0 å…¨éˆæ¢æ¥åŠ› - æˆ°ç•¥è³‡æºè‡ªå‹•é‡è¨­ç‰ˆ
# scraper & zenrows å›ºå®šæ¯æœˆ1æ—¥å–šé†’é€²è¡Œæ¢å¾©é»æ•¸ï¼Œå…¶é¤˜å‘¨ä¸€~äº” 03:00 åŸ·è¡Œä»»å‹™
##########################################################################
name: ğŸƒ S-Plan podcast

on:
  schedule:
    - cron: '0 19 * * 1-5' # é€±ä¸€è‡³é€±äº” 03:00 (å°åŒ—æ™‚é–“)
    - cron: '0 19 1 * *'    # æ¯æœˆ 1 æ—¥å‡Œæ™¨ 03:00 å–šé†’

  workflow_dispatch:
    inputs:
      force_mode:
        description: 'ğŸš€ é¸æ“‡ä½œæˆ°æ¨¡å¼ (AUTO ç‚ºè‡ªå‹•æ±ºç­–)'
        required: true
        default: 'AUTO'
        type: choice
        options: 
          - AUTO
          - MODE_1_Scrapi
          - MODE_2_Zenrows
          - MODE_3_Webscrap
          - MODE_4_Scrapedo

jobs:
  relay_mission:
    runs-on: ubuntu-latest
    timeout-minutes: 180 

    # ğŸš€ é›†ä¸­å®šç¾© Job ç´šåˆ¥ env (ä¸‹æ–¹æ‰€æœ‰ steps éƒ½æœƒè‡ªå‹•ç¹¼æ‰¿)
    env:

      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }} # ğŸš€ ä¿®æ­£ï¼šå°ä½æ³•å®šæ¸…å–®
      R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
      R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }} # ğŸš€ è£œé½Šï¼šå€‰åº«è·¯å¾‘    
        
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      
      SCRAP_API_KEY: ${{ secrets.SCRAP_API_KEY }}
      ZENROWS_API_KEY: ${{ secrets.ZENROWS_API_KEY }}
      WEBSCRAP_API_KEY: ${{ secrets.WEBSCRAP_API_KEY }} # ğŸš€ ä¿®æ­£ï¼šå°ä½æ³•å®šæ¸…å–®
      SCRAPEDO_API_KEY: ${{ secrets.SCRAPEDO_API_KEY }} # ğŸš€ ä¿®æ­£ï¼šå°ä½æ³•å®šæ¸…å–®

# ğŸš€ è£œé½Šï¼šæ¥åŠ›é€šè¨Šçµ„ä»¶ (è‹¥ç„¡æ­¤äºŒé …ï¼ŒRender ç„¡æ³•è¢«å–šé†’)
      RENDER_WEBHOOK_URL: ${{ secrets.RENDER_WEBHOOK_URL }}
      CRON_SECRET: ${{ secrets.CRON_SECRET }}
      PYTHONUNBUFFERED: 1

    steps:
    - name: ğŸ“¦ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4

    - name: ğŸ è¨­å®š Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: âš™ï¸ å®‰è£å¿…è¦ä¾è³´èˆ‡ FFmpeg
      # ä¸€è¡Œè¨»è§£ï¼šå®‰è£éŸ³è¨Šå£“ç¸®æ‰€éœ€å·¥å…· ffmpegã€‚
      run: |
        sudo apt-get update && sudo apt-get install -y ffmpeg
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 supabase python-dotenv boto3 google-generativeai groq

    - name: ğŸ¯ åŸ·è¡Œè§£ç¢¼ä»»å‹™ (Officer)
      # ä¸€è¡Œè¨»è§£ï¼šåƒ…ä¿ç•™æ­¤æ­¥é©Ÿç‰¹æœ‰çš„æˆ°ç•¥åˆ‡æ›è®Šæ•¸ã€‚
      env:
        STRATEGY_MODE: ${{ github.event.inputs.force_mode || 'AUTO' }}
      run: |
        echo "ğŸ“¡ [å•Ÿå‹•] è§£ç¢¼å®˜åŸ·è¡Œä»»å‹™ï¼Œç•¶å‰æˆ°ç•¥æ¨¡å¼: $STRATEGY_MODE"
        python src/pod_scra_officer.py

    - name: ğŸ•’ æˆ°è¡“è§€å¯ŸæœŸ (ç­‰å¾…è§£ç¢¼å®˜å®Œæˆç‰©è³‡å…¥åº«)
      run: sleep 300 

    - name: ğŸšš åŸ·è¡Œé‹è¼¸ã€éŸ³è¨Šå£“ç¸®èˆ‡ AI æ‘˜è¦
      run: python src/pod_scra_transport.py

    - name: ğŸ§¹ åŸ·è¡Œå…©éšæ®µåº«å­˜é‡ç”Ÿèˆ‡æ¸…ç†
      # ä¸€è¡Œè¨»è§£ï¼šåœ¨æœ€å¾Œéšæ®µæ¸…ç†æˆ–é‡ç”Ÿ 7/14 å¤©å‰çš„ä»»å‹™ã€‚
      run: python src/pod_scra_cleaner.py